name: Preview (Backend)

on:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: read

    # Use our runner image (root user; we chown workspace to appuser before npm)
    container:
      image: ghcr.io/${{ github.repository }}/snf-runner:latest

    env:
      PR_NUMBER: ${{ github.event.number }}
      RENDER_URL: https://sniffr-staging-pr-${{ github.event.number }}.onrender.com
      # Optional: if you later enable pretty URLs via Cloudflare Worker, set this repo var
      # PRETTY_DOMAIN should be your apex domain, e.g. "sniffrpack.com"
      PRETTY_DOMAIN: ${{ vars.PRETTY_DOMAIN }}

    steps:
      - name: Who am I
        run: |
          whoami && id
          ls -ld /__w /__w/_temp || true

      - uses: actions/checkout@v4

      - name: Fix workspace ownership for appuser
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          chown -R appuser:appuser "$GITHUB_WORKSPACE"
          chown -R appuser:appuser /__w/_temp || true
          chown -R appuser:appuser /github/home || true

      - name: Install deps (as appuser)
        run: su -s /bin/bash appuser -c "npm ci || npm install --no-audit --no-fund"

      - name: Build (as appuser)
        run: su -s /bin/bash appuser -c "npm run build --if-present"

      - name: Wait for Render preview to come up
        run: |
          URL="$RENDER_URL"
          echo "Polling $URL/healthz ..."
          for i in {1..40}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL/healthz" || true)
            if [ "$code" = "200" ]; then
              echo "Health OK"
              echo "RENDER_OK=1" >> $GITHUB_ENV
              break
            fi
            sleep 5
          done
          if [ "${RENDER_OK:-}" != "1" ]; then
            echo "Health not green yet, but Render is often racey; continuing to comment links…"
          fi

      - name: Compose preview links
        id: compose
        run: |
          RENDER_MSG="✅ API Preview (Render): $RENDER_URL"
          if [ -n "$PRETTY_DOMAIN" ]; then
            PRETTY_URL="https://pr-${PR_NUMBER}-stage.${PRETTY_DOMAIN}"
            PRETTY_MSG="✨ Pretty URL: ${PRETTY_URL}"
          else
            PRETTY_MSG=""
          fi

          echo "render=$RENDER_MSG" >> $GITHUB_OUTPUT
          echo "pretty=$PRETTY_MSG" >> $GITHUB_OUTPUT

      - name: Comment Preview URLs
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ${{ steps.compose.outputs.render }}
            ${{ steps.compose.outputs.pretty }}
