name: Preview (Backend)

on:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: read

    container:
      image: ghcr.io/${{ github.repository }}/snf-runner:latest
      # image defaults to root (so checkout can write). We'll drop to appuser later.

    steps:
      - name: Sanity (whoami / id / mounts)
        run: |
          whoami && id
          ls -ld /__w /__w/_temp || true

      - uses: actions/checkout@v4

      - name: Fix workspace perms for appuser
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          chown -R appuser:appuser "$GITHUB_WORKSPACE"
          chown -R appuser:appuser /__w/_temp || true
          chown -R appuser:appuser /github/home || true

      - name: Verify ownership (should be appuser:appuser)
        run: |
          ls -ld "$GITHUB_WORKSPACE"
          # also show a few top-level entries for sanity
          ls -l "$GITHUB_WORKSPACE" | head -20

      # Node 20 is already in the container; keeping it lean.

      - name: Install deps (as appuser)
        run: su -s /bin/bash appuser -c "npm ci || npm install --no-audit --no-fund"

      - name: Build (as appuser)
        run: su -s /bin/bash appuser -c "npm run build --if-present"

      - name: Tests (non-fatal placeholder; as appuser)
        run: su -s /bin/bash appuser -c "node -e \"console.log('âœ“ tests temporarily skipped')\""

      - name: Smoke check /healthz (Render)
        run: |
          URL="https://sniffr-staging-pr-${{ github.event.number }}.onrender.com"
          echo "Checking $URL/healthz ..."
          for i in {1..30}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL/healthz" || true)
            if [ "$code" = "200" ]; then echo "OK"; exit 0; fi
            sleep 3
          done
          echo "Health check failed"; exit 1

      - name: Comment Preview URLs (Render)
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            âœ… API Preview (Render): https://sniffr-staging-pr-${{ github.event.number }}.onrender.com
            ðŸ”Ž RapiDoc: https://sniffr-staging-pr-${{ github.event.number }}.onrender.com/rapi-doc/rapidoc.html
