name: Preview (Backend)

on:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: read

    container:
      image: ghcr.io/${{ github.repository }}/snf-runner:latest
      # run as container default user (root). Do not change ownership of host mounts.

    env:
      PR_NUM: ${{ github.event.number }}
      RENDER_URL: https://sniffr-staging-pr-${{ github.event.number }}.onrender.com
      PRETTY_URL: https://pr-${{ github.event.number }}-stage.sniffrpack.com

    steps:
      - name: Sanity (whoami / id / mounts)
        run: |
          whoami && id
          ls -ld /__w /__w/_temp || true

      - uses: actions/checkout@v4

      # Node is preinstalled in the runner image; use npm as root to avoid FS perms issues.
      - name: Install deps
        run: npm ci || npm install --no-audit --no-fund

      - name: Build
        run: npm run build --if-present

      - name: Tests (temporary placeholder)
        run: node -e "console.log('‚úì tests temporarily skipped')"

      # Health check the Render PR deploy
      - name: Smoke check /healthz (Render)
        run: |
          echo "Checking $RENDER_URL/healthz ..."
          for i in {1..40}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$RENDER_URL/healthz" || true)
            if [ "$code" = "200" ]; then echo "OK"; exit 0; fi
            sleep 3
          done
          echo "Health check failed"; exit 1

      # Comment preview URLs: Render + (likely) pretty Cloudflare CNAME if present
      - name: Comment Preview URLs
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ‚úÖ API Preview (Render): https://sniffr-staging-pr-${{ github.event.number }}.onrender.com
            üîé RapiDoc: https://sniffr-staging-pr-${{ github.event.number }}.onrender.com/rapi-doc/rapidoc.html
            üåê Pretty URL: https://pr-${{ github.event.number }}-stage.sniffrpack.com
