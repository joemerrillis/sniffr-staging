name: Preview (Backend)

on:
  pull_request:

jobs:
  backend:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
      packages: read

    steps:
      - name: Fix runner temp perms (pre-checkout)
        run: |
          sudo chown -R $(id -u):$(id -g) /__w/_temp || true
          sudo chmod -R u+rwX /__w/_temp || true

      - uses: actions/checkout@v3

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install OS tools
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep sqlite3

      - name: Cache npm
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: npm-${{ hashFiles('package-lock.json') }}

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Tests
        run: npm test --if-present

      - name: Install Railway CLI
        run: |
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          railway --version

      - name: Deploy backend preview
        id: deploy
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_SERVICE: sniffr-staging
          RAILWAY_ENV: pr-${{ github.event.number }}
        run: bash scripts/deploy-preview-backend.sh

      - name: Smoke check /healthz
        run: |
          URL="${{ steps.deploy.outputs.api_url }}"
          echo "Checking $URL/healthz ..."
          for i in {1..20}; do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL/healthz" || true)
            if [ "$code" = "200" ]; then
              echo "OK"
              exit 0
            fi
            sleep 3
          done
          echo "Health check failed"
          exit 1

      - name: Comment Preview URLs
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            âœ… API Preview: ${{ steps.deploy.outputs.api_url }}
            ðŸ”Ž RapiDoc: ${{ steps.deploy.outputs.api_url }}/rapidoc?url=${{ steps.deploy.outputs.api_url }}/openapi.json
